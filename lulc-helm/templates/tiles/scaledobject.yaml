{{- if .Values.tiles.enabled }}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ template "lulc-helm.fullname" . }}-tiles-scaler
spec:
  scaleTargetRef:
    name: {{ template "lulc-helm.fullname" . }}-tiles
  minReplicaCount: 16
  maxReplicaCount: 64
  cooldownPeriod: 300
  pollingInterval: 20
  triggers:
  - type: azure-monitor
    metadata:
      resourceURI: Microsoft.Network/applicationGateways/lulcStagingApplicationGateway3
      tenantId: {{ .Values.tilesScaler.env.tenantId }}
      subscriptionId: {{ .Values.tilesScaler.env.subscriptionId }}
      resourceGroupName: lulcStaging
      metricName: AvgRequestCountPerHealthyHost
      metricFilter: BackendSettingsPool eq '{{ .Values.tilesScaler.env.backendPool }}'
      metricAggregationInterval: "0:1:0"
      metricAggregationType: 'Average'
      targetValue: "2"
    authenticationRef:
      name: {{ template "lulc-helm.fullname" . }}-azure-monitor-trigger-auth

{{- end }}