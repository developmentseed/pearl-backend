{{- if .Values.tiles.enabled }}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ template "lulc-helm.fullname" . }}-tiles-scaler
spec:
  scaleTargetRef:
    name: {{ template "lulc-helm.fullname" . }}-tiles
  minReplicaCount: 2
  maxReplicaCount: 12
  triggers:
  - type: azure-monitor
    metadata:
      resourceURI: Microsoft.ContainerService/managedClusters/lulcStagingAks3
      tenantId: {{ .Values.tilesScaler.env.tenantId }}
      subscriptionId: {{ .Values.tilesScaler.env.subscriptionId }}
      resourceGroupName: lulcStaging
      metricName: AvgRequestCountPerHealthyHost
      metricFilter: BackendSettingsPool eq '{{ .Values.tilesScaler.env.backendPool }}'
      metricAggregationInterval: "0:1:0"
      metricAggregationType: 'Average'
      targetValue: "10"
    authenticationRef:
      name: {{ template "lulc-helm.fullname" . }}-azure-monitor-trigger-auth

{{- end }}